# 要件定義書

## 概要

本文書は、既存フロントエンド仕様を変更せずに接続可能なFastAPIベースのバックエンドシステムの要件を定義します。このシステムは、フロントエンドテスト用の一時的なソリューションとして機能し、将来のJava/Spring Boot + PostgreSQLへの明確な移行パスを維持します。学習帳、問題、学習分析機能を持つタイピング練習アプリケーションを実装し、全文検索機能と構造化ログを特徴とします。

バックエンドはドメイン駆動設計の原則に従い、明確な層分離（API/App/Domain/Infrastructure）を行い、開発時はSQLiteとFTS5を使用し、本番環境でのPostgreSQLのtsvector/pg_trgmへのシームレスな移行を想定して設計されています。

## 要件

### 要件1: アーキテクチャと層分離

**ユーザーストーリー:** 開発者として、明確な層分離を持つ構造化されたバックエンドが欲しい。コードベースが保守可能で、異なる技術への移行が容易になるように。

#### 受入基準

1. システムが設計される時、リポジトリパターンを使用してDomain/App(Service)/Infra(DB, Search)/API層分離を実装すること
2. コードが整理される時、ドメインモデルがデータベース非依存で関心事を分離すること
3. 依存関係が管理される時、インフラストラクチャがドメインインターフェースに依存し、その逆ではないこと
4. システムが構築される時、層間の疎結合のために依存性注入を使用すること

### 要件2: API契約とドキュメント（既存フロント仕様維持）

**ユーザーストーリー:** フロントエンド開発者として、既存フロント仕様を変更せずに接続できる、OpenAPI仕様を持つ十分にドキュメント化されたAPIが欲しい。バックエンドと効率的に統合し、利用可能なすべてのエンドポイントを理解できるように。

#### 受入基準

1. APIが設計される時、API契約の単一の真実の源としてOpenAPIを使用すること
2. サーバーが起動する時、/docsエンドポイントでインタラクティブなAPIドキュメントを提供すること
3. APIレスポンスが返される時、リクエスト/レスポンス検証のために一貫したPydanticモデルに従うこと
4. エンドポイントがアクセスされる時、適切なHTTPステータスコードとエラーメッセージを返すこと
5. 既存フロントエンドが変更なしで接続できるREST APIを提供すること

### 要件3: データベース設計と移行戦略

**ユーザーストーリー:** システム管理者として、開発時はSQLiteで動作し、本番環境ではPostgreSQLに移行できるデータベースが欲しい。デプロイメント環境での柔軟性を持つために。

#### 受入基準

1. データベースが初期化される時、PRAGMA foreign_keys=ONとjournal_mode=WALを設定したSQLiteを使用すること
2. データベースマイグレーションが管理される時、バージョン管理にAlembicを使用すること
3. IDが生成される時、データベース間互換性のためにTEXTとして保存されるUUID形式を使用すること
4. タイムスタンプが保存される時、ISO8601形式のUTCタイムゾーンを使用すること
5. システムが設計される時、将来のPostgreSQL移行と互換性のあるデータベーススキーマであること

### 要件4: ユーザー管理と認証

**ユーザーストーリー:** ユーザーとして、アカウントを作成し、他のユーザーからデータを分離したい。学習進捗と学習教材がプライベートで安全になるように。

#### 受入基準

1. ユーザーがサインアップする時、UUID、名前、メールアドレスを持つ一意のユーザーレコードを作成すること
2. ユーザーデータがアクセスされる時、データ分離を確保するために常にuser_idでスコープされること
3. 認証が実装される時、将来のOIDC移行機能を持つモック認証をサポートすること
4. ユーザーメールアドレスが処理される時、システム全体で一意であること

### 要件5: 学習帳管理

**ユーザーストーリー:** 学習者として、問題と回答を含む学習帳を作成・管理したい。トピックや科目別に学習教材を整理できるように。

#### 受入基準

1. 学習帳が作成される時、特定のユーザーに属し、タイトルと説明を含むこと
2. 学習帳がアクセスされる時、所有者のみに表示される（user_idスコープ）こと
3. 学習帳が管理される時、ユーザーが自分の学習帳を作成、読み取り、更新、削除できること
4. 学習帳データが保存される時、created_atとupdated_atの適切なタイムスタンプを含むこと

### 要件6: 問題管理とランダム出題

**ユーザーストーリー:** 学習者として、学習帳に問題を追加し、練習用にランダムな問題を取得したい。知識を効果的にテストできるように。

#### 受入基準

1. 問題が作成される時、学習帳に属し、言語、カテゴリ、難易度、問題文、回答を含むこと
2. ランダム問題が要求される時、指定された学習帳からランダムな問題を返すこと
3. 問題の回答が返される時、リクエストパラメータに基づいてオプションで非表示にできること
4. 問題がアクセスされる時、学習帳の関係を通じてユーザー所有権でフィルタリングされること

### 要件7: 全文検索機能

**ユーザーストーリー:** 学習者として、キーワードを使って問題と回答を検索したい。学習教材の特定のコンテンツを素早く見つけられるように。

#### 受入基準

1. 検索が実装される時、問題と回答の全文検索にSQLite FTS5を使用すること
2. 検索結果が返される時、関連性スコアとハイライトされたマッチを含むこと
3. 検索戦略が設計される時、将来のPostgreSQL tsvector/pg_trgm移行のためのインターフェースパターンを使用すること
4. 検索インデックスが維持される時、問題の更新と自動的に同期されること

### 要件8: タイピング性能追跡

**ユーザーストーリー:** 学習者として、タイピング性能を記録・追跡したい。時間の経過とともに進歩と改善を監視できるように。

#### 受入基準

1. タイピングセッションが完了する時、WPM、正確性、継続時間、関連する問題を記録すること
2. タイピングログが保存される時、ユーザーにリンクされ、オプションで特定の問題にリンクされること
3. タイピング性能が追跡される時、時系列分析のためのタイムスタンプを含むこと
4. タイピングデータがアクセスされる時、プライバシーのためにuser_idでスコープされること

### 要件9: 学習分析とイベント

**ユーザーストーリー:** 学習者およびシステム管理者として、学習活動をイベントとして追跡したい。学習パターンとシステム使用状況を分析できるように。

#### 受入基準

1. 学習イベントが発生する時、user_id、app_id、アクション、タイムスタンプで記録されること
2. イベントが保存される時、詳細な分析のためにobject_id、スコア、継続時間をオプションで含むこと
3. 学習イベントが取得される時、ページネーション付きで時系列順に返されること
4. イベントデータがアクセスされる時、プライバシーのためにuser_idでスコープされること

### 要件10: 構造化ログと監視

**ユーザーストーリー:** システム管理者として、包括的な構造化ログが欲しい。システムの健全性を監視し、問題を効果的にトラブルシュートできるように。

#### 受入基準

1. ログが生成される時、構造化JSON形式であること
2. ログエントリが作成される時、trace_id、user_id、app_id、バージョン情報を含むこと
3. システムが起動する時、ヘルス監視のための/healthzエンドポイントを提供すること
4. ヘルスチェックが実行される時、データベース接続を検証し、適切なステータスを返すこと

### 要件11: コンテナ化とデプロイメント

**ユーザーストーリー:** 開発者として、シンプルなデプロイメントでアプリケーションをコンテナ化したい。異なる環境で簡単にデプロイ・スケールできるように。

#### 受入基準

1. アプリケーションがコンテナ化される時、スリムなベースイメージでDockerを使用すること
2. システムがデプロイされる時、ワンコマンド起動のために`docker compose up -d`をサポートすること
3. 設定が管理される時、.env.localファイルからの環境変数を使用すること
4. コンテナが起動する時、ヘルスチェックと適切なシグナル処理を含むこと

### 要件12: データシードと開発サポート

**ユーザーストーリー:** 開発者として、システムにテストデータを簡単に投入したい。開発・テスト環境を素早くセットアップできるように。

#### 受入基準

1. シードデータが必要な時、ワンコマンドシードスクリプトを提供すること
2. シードデータが作成される時、サンプルユーザー、学習帳、問題、タイピングログを含むこと
3. 開発セットアップが実行される時、ローカルPythonとDocker環境の両方で動作すること
4. シード操作が実行される時、冪等性があり、複数回実行しても安全であること

### 要件13: 将来の移行準備

**ユーザーストーリー:** システムアーキテクトとして、Java/Spring BootとPostgreSQLへの簡単な移行のためにコードベースを設計したい。本番環境でシステムをスケールできるように。

#### 受入基準

1. コードが構造化される時、Java/Spring Bootと互換性のある命名規則を使用すること
2. データベーススキーマが設計される時、FlywayでPostgreSQLに簡単に変換できること
3. APIが設計される時、エンドポイント名とDTOがSpring Boot規約に従うこと
4. システムがドキュメント化される時、明確な移行ロードマップと戦略を含むこと

### 要件14: コード品質とシンプルさ

**ユーザーストーリー:** 開発者として、可読性に優れたシンプルなコードベースが欲しい。保守性を高め、不要な複雑さを避けるために。

#### 受入基準

1. コードが作成される時、可読性に優れ、理解しやすいシンプルな実装であること
2. ファイルが作成される時、必要最小限のファイル数で機能を実現すること
3. 余分なファイルが存在する時、都度削除して整理すること
4. 各実装工程が完了する時、同一ルールの下でコードのリファクタリングを実行すること
5. 抽象化が行われる時、過度な抽象化を避け、実用的なレベルに留めること
6. 依存関係が追加される時、必要最小限の外部ライブラリのみを使用すること