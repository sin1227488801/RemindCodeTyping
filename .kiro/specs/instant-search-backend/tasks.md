# 実装計画

- [x] 1. プロジェクト構造とコア設定のセットアップ





  - api/, app/, domain/, infra/, migrations/, tests/, scripts/のディレクトリ構造を作成
  - 環境変数と設定による設定管理を実装
  - FastAPI、SQLAlchemy、Alembic、pytest依存関係を含むrequirements.txtを作成
  - 不要なファイルを削除し、最小限の構成で機能を実現
  - _要件: 1.1, 1.2, 11.3, 14.1, 14.2, 14.3_

- [x] 1.1 コード品質チェックとリファクタリング（フェーズ1）


  - プロジェクト構造の可読性とシンプルさを検証
  - 重複コードや不要なファイルを特定・削除
  - 命名規則の統一と一貫性を確保
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 2. ドメイン層の基盤実装





  - [x] 2.1 ドメインモデルとDTOの作成


    - User、StudyBook、Question、TypingLog、LearningEventのPydanticモデルを作成
    - ドメイン値オブジェクトと検証ルールを実装
    - ドメイン固有のデータ転送オブジェクトを作成
    - _要件: 1.2, 4.1, 5.1, 6.1, 8.1, 9.1_

  - [x] 2.2 リポジトリインターフェースの定義


    - UserRepository、StudyBookRepository、QuestionRepositoryの抽象基底クラスを作成
    - TypingLogRepositoryとLearningEventRepositoryインターフェースを定義
    - 適切な型付けでリポジトリメソッドシグネチャを実装
    - _要件: 1.1, 1.3, 4.2, 5.2, 6.4, 8.4, 9.4_

  - [x] 2.3 ドメイン例外とエラーハンドリングの作成


    - DomainException基底クラスと特定の例外を実装
    - エラーレスポンスモデルとステータスコードマッピングを作成
    - UserNotFoundError、StudyBookNotFoundErrorなどの例外階層を作成
    - _要件: 2.4, 4.2, 5.2_

- [x] 2.4 コード品質チェックとリファクタリング（フェーズ2）


  - ドメイン層の可読性とシンプルさを検証
  - 過度な抽象化を避け、実用的なレベルに調整
  - ドメインモデルの命名規則と一貫性を確保
  - 重複コードの排除とDRY原則の適用
  - _要件: 14.1, 14.2, 14.4, 14.5_

- [x] 3. 検索戦略インターフェースとSQLite実装





  - [x] 3.1 検索戦略インターフェースの作成


    - search_questionsメソッドを持つSearchStrategy抽象基底クラスを定義
    - ハイライト機能付き検索レスポンス用SearchResultモデルを作成
    - rebuild_index機能のインターフェースを実装
    - _要件: 7.3, 7.2_

  - [x] 3.2 SQLite FTS5検索戦略の実装


    - SearchStrategyインターフェースを実装するSQLiteFtsStrategyクラスを作成
    - SQLite FTS5仮想テーブルを使用した全文検索を実装
    - 関連性スコアと結果ハイライト機能を追加
    - _要件: 7.1, 7.2, 7.4_

- [x] 3.3 コード品質チェックとリファクタリング（フェーズ3）


  - 検索戦略実装の可読性とシンプルさを検証
  - インターフェースと実装の適切な分離を確認
  - 検索機能の命名規則と一貫性を確保
  - 不要な複雑さを排除し、シンプルな実装に調整
  - _要件: 14.1, 14.2, 14.4, 14.5_

- [x] 4. SQLAlchemyによるデータベースインフラストラクチャのセットアップ





  - [x] 4.1 SQLAlchemyモデルとデータベース設定の作成


    - 全エンティティのSQLAlchemy ORMモデルを実装
    - SQLite PRAGMA設定でデータベース接続を設定
    - データベースセッション管理と依存性注入を作成
    - _要件: 3.1, 3.3, 3.4, 3.5_

  - [x] 4.2 Alembicマイグレーションの実装


    - データベースマイグレーション用Alembic設定を初期化
    - 全テーブルスキーマとインデックスを含む初期マイグレーションを作成
    - FTS5仮想テーブル作成と同期トリガーを実装
    - _要件: 3.2, 7.4_

  - [x] 4.3 リポジトリ具象クラスの実装


    - 全リポジトリインターフェースのSQLAlchemyベース実装を作成
    - 適切なフィルタリングでユーザースコープデータアクセスを実装
    - トランザクション管理とエラーハンドリングを追加
    - _要件: 1.1, 4.2, 5.2, 6.4, 8.4, 9.4_

- [x] 4.4 コード品質チェックとリファクタリング（フェーズ4）


  - データベースインフラストラクチャの可読性とシンプルさを検証
  - SQLAlchemyモデルとリポジトリ実装の一貫性を確保
  - データベース設定とマイグレーションの整理
  - 不要な設定ファイルや重複コードを削除
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 5. 認証とユーザー管理の実装





  - [x] 5.1 認証サービスインターフェースとモック実装の作成


    - AuthenticationService抽象基底クラスを定義
    - 開発用MockAuthenticationServiceを実装
    - ユーザーコンテキスト管理と依存性注入を作成
    - _要件: 4.3, 13.1_

  - [x] 5.2 ユーザーサインアップと管理エンドポイントの実装


    - メールアドレス一意性検証付きユーザー登録エンドポイントを作成
    - ユーザー検索と認証ミドルウェアを実装
    - 全操作にユーザースコープリクエストコンテキストを追加
    - _要件: 4.1, 4.2, 4.4_

- [x] 5.3 コード品質チェックとリファクタリング（フェーズ5）


  - 認証とユーザー管理の可読性とシンプルさを検証
  - 認証サービスとエンドポイントの一貫性を確保
  - モック実装の適切な分離と将来の拡張性を確認
  - 不要な認証ロジックや重複コードを削除
  - _要件: 14.1, 14.2, 14.4, 14.5_

- [x] 6. FastAPIによるコアAPIエンドポイントの実装





  - [x] 6.1 ヘルスチェックと監視エンドポイントの作成


    - データベース接続チェック付き/healthzエンドポイントを実装
    - 検索インデックスヘルス検証を追加
    - コンポーネントステータス付き構造化ヘルスレスポンスを作成
    - _要件: 10.3, 10.4_

  - [x] 6.2 学習帳管理APIの実装


    - ユーザースコープ付き学習帳CRUDエンドポイントを作成
    - Pydanticモデルを使用したリクエスト/レスポンス検証を実装
    - 適切なHTTPステータスコードとエラーレスポンスを追加
    - _要件: 2.1, 2.3, 2.4, 5.1, 5.2, 5.3, 5.4_

  - [x] 6.3 問題管理とランダム選択APIの実装


    - 学習帳関連付け付き問題CRUDエンドポイントを作成
    - オプション回答非表示付きランダム問題選択を実装
    - 学習帳関係を通じたユーザー所有権検証を追加
    - _要件: 2.1, 2.3, 2.4, 6.1, 6.2, 6.3, 6.4_

  - [x] 6.4 検索APIエンドポイントの実装


    - 検索戦略インターフェースを使用した問題検索エンドポイントを作成
    - クエリパラメータ検証と結果フォーマットを追加
    - 適切な認可付きユーザースコープ検索を実装
    - _要件: 2.1, 2.3, 7.1, 7.2_

  - [x] 6.5 タイピング性能追跡APIの実装


    - 検証付きタイピングログ作成エンドポイントを作成
    - ユーザースコープタイピングログ取得を実装
    - 問題関連付けと性能メトリクス保存を追加
    - _要件: 2.1, 2.3, 8.1, 8.2, 8.3, 8.4_

  - [x] 6.6 学習分析APIの実装


    - 学習イベント記録エンドポイントを作成
    - 時系列順序付きページネーション学習イベント取得を実装
    - 適切なフィルタリング付きユーザースコープ分析を追加
    - _要件: 2.1, 2.3, 9.1, 9.2, 9.3, 9.4_

- [x] 6.7 コード品質チェックとリファクタリング（フェーズ6）


  - APIエンドポイントの可読性とシンプルさを検証
  - エンドポイント間の一貫性とパターンの統一
  - リクエスト/レスポンスモデルの整理と重複排除
  - 不要なルーターファイルやヘルパー関数を削除
  - エラーハンドリングの統一と簡素化
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 7. 構造化ログと監視の実装





  - [x] 7.1 構造化JSONログのセットアップ


    - 必須フィールド（trace_id、user_id、app_id、version）付きJSONフォーマッターを設定
    - リクエストトレーシング用ログミドルウェアを実装
    - ログエントリモデルと構造化出力を作成
    - _要件: 10.1, 10.2_

  - [x] 7.2 リクエストトレーシングと監視の追加


    - トレースID生成と伝播ミドルウェアを実装
    - 全ログエントリにユーザーコンテキストを追加
    - パフォーマンス監視とエラー追跡を作成
    - _要件: 10.1, 10.2_

- [x] 7.3 コード品質チェックとリファクタリング（フェーズ7）


  - ログと監視実装の可読性とシンプルさを検証
  - ログ設定とミドルウェアの一貫性を確保
  - 不要なログレベルや重複する監視コードを削除
  - ログフォーマットの統一と簡素化
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 8. コンテナ化とデプロイメント設定の作成





  - [x] 8.1 DockerfileとDocker Composeセットアップの作成


    - スリムPythonベースイメージとヘルスチェック付きDockerfileを作成
    - サービス設定付きdocker-compose.ymlを作成
    - 環境変数設定と.env.localテンプレートを追加
    - _要件: 11.1, 11.2, 11.3, 11.4_

  - [x] 8.2 開発操作用Makefileの作成


    - up/down/test/seed/format操作用makeターゲットを実装
    - データベースマイグレーションとシードデータコマンドを追加
    - 開発ワークフロー自動化を作成
    - _要件: 12.1, 12.3_

- [x] 8.3 コード品質チェックとリファクタリング（フェーズ8）


  - コンテナ化設定の可読性とシンプルさを検証
  - DockerfileとCompose設定の最適化
  - 不要な環境変数や設定ファイルを削除
  - Makefileコマンドの整理と統一
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 9. データシードと開発サポートの実装





  - [x] 9.1 シードデータスクリプトの作成


    - サンプルユーザー、学習帳、問題を生成するPythonスクリプトを作成
    - 適切なエラーハンドリング付き冪等シード操作を実装
    - リアルなテストデータ用タイピングログと学習イベントを追加
    - _要件: 12.1, 12.2, 12.4_

  - [x] 9.2 開発セットアップドキュメントの作成


    - ローカルとDockerセットアップ手順付きREADME.mdを作成
    - /docs参照とトラブルシューティング付きAPI使用方法をドキュメント化
    - 移行ロードマップとアーキテクチャドキュメントを追加
    - _要件: 13.4_

- [x] 9.3 コード品質チェックとリファクタリング（フェーズ9）


  - シードスクリプトとドキュメントの可読性を検証
  - 不要なシードデータファイルやスクリプトを削除
  - ドキュメントの一貫性と簡潔性を確保
  - 開発サポートツールの整理と統一
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 10. 包括的テストスイートの実装





  - [x] 10.1 ドメイン層のユニットテスト作成


    - ドメインモデル、検証ルール、ビジネスロジックのテストを作成
    - モックを使用したリポジトリインターフェース契約テストを実装
    - ドメイン例外とエラーハンドリングテストを追加
    - _要件: 1.2, 4.1, 5.1, 6.1, 8.1, 9.1_

  - [x] 10.2 APIエンドポイントの統合テスト作成


    - テストデータベースセットアップ付きAPIエンドポイントテストを作成
    - ユーザー認証と認可テストを実装
    - 検索機能とデータベース統合テストを追加
    - _要件: 2.1, 2.3, 4.2, 5.2, 6.4, 7.1, 8.4, 9.4_

  - [x] 10.3 リポジトリ契約テストの作成


    - 全リポジトリ実装の契約テストを実装
    - インメモリデータベース付きSQLite固有機能テストを追加
    - 一貫したテスト用テストフィクスチャとデータファクトリを作成
    - _要件: 1.1, 3.1, 7.4_

- [x] 10.4 コード品質チェックとリファクタリング（フェーズ10）


  - テストスイートの可読性とシンプルさを検証
  - 重複するテストケースや不要なテストファイルを削除
  - テストフィクスチャとヘルパー関数の整理
  - テスト命名規則の統一と一貫性確保
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5_

- [x] 11. 移行ドキュメントとロードマップの作成




  - [x] 11.1 PostgreSQL移行戦略のドキュメント化


    - SQLiteからPostgreSQLへの詳細移行ガイドを作成
    - FTS5からtsvector/pg_trgmへの検索戦略置換をドキュメント化
    - データ移行スクリプトと検証手順を追加
    - _要件: 3.5, 7.3, 13.1, 13.2_

  - [x] 11.2 Spring Boot移行ロードマップのドキュメント化


    - Java/Spring Boot移行の包括的ロードマップを作成
    - API互換性と命名規則整合性をドキュメント化
    - インフラストラクチャとデプロイメント移行戦略を追加
    - _要件: 13.1, 13.3, 13.4_

- [x] 11.3 最終コード品質チェックとリファクタリング（フェーズ11）


  - 全体的なコードベースの可読性とシンプルさを最終検証
  - プロジェクト全体の一貫性と統一性を確保
  - 不要なファイル、コメント、デッドコードを完全削除
  - 命名規則、コーディングスタイル、アーキテクチャパターンの最終統一
  - ドキュメントとコードの整合性を確認
  - _要件: 14.1, 14.2, 14.3, 14.4, 14.5, 14.6_